{% extends 'base.html' %}
{% block title %}IvoryOS | Design execution{% endblock %}

{% block body %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>

    {% if no_deck_warning and not dismiss %}
        {# auto pop import when there is no deck#}
        <script type="text/javascript">
            function OpenBootstrapPopup() {
                $("#importModal").modal('show');
            }
            window.onload = function () {
                OpenBootstrapPopup();
            };
        </script>
    {% endif %}

    <div class="row">
        {% include 'components/run_panel.html' %}
        {% include 'components/progress_panel.html' %}
        {% include 'components/logging_panel.html' %}
    </div>
<<<<<<< Updated upstream
</div>


<div class="tab-pane fade" id="tab3" role="tabpanel" aria-labelledby="tab3-tab">
    <form method="POST" name="bo" action="{{ url_for('design.experiment_run') }}">
        <div class="container py-2">
            <!-- Data Loading Section -->
            <h6 class="fw-bold mt-2 mb-1">Load Previous Data</h6>
            <div class="row align-items-center mb-3">
                <div class="col-6">
                    <div class="input-group">
                        <label class="input-group-text"><i class="bi bi-folder2-open"></i></label>
                        <select class="form-select" id="existing_data" name="existing_data">
                            <option value="">Load existing data...</option>
                            {% for data in data_list %}
                                <option value="{{ data }}">{{ data }} </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-6">
                    <form method="POST" id="loadHistory" name="loadHistory" action="{{ url_for('design.upload_history') }}" enctype="multipart/form-data">
                        <div class="input-group">
                            <input class="form-control" name="historyfile" id="historyfile" type="file" accept=".csv" onchange="var f=document.getElementById('loadHistory'); if(f) f.submit();">
                        </div>
                    </form>
                </div>
            </div>

            <!-- Custom path input -->
            <div class="row align-items-center mb-3" id="custom_path_row" style="display: none;">
                <div class="col-3 col-form-label-sm">
                    Custom Path:
                </div>
                <div class="col-7">
                    <input type="text" class="form-control form-control-sm" id="custom_path" name="custom_path" placeholder="/path/to/data/folder">
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="validateCustomPath()">Validate</button>
                </div>
            </div>

            <!-- Data preview section -->
            <div class="row mb-3" id="data_preview_section" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-2">
                            <small class="fw-bold">Data Preview</small>
                        </div>
                        <div class="card-body py-2">
                            <div id="data_preview_content">
                                <small class="text-muted">Select a data source to preview</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-3">

            <!-- Parameters -->
            <h6 class="fw-bold mt-2 mb-1">Parameters</h6>
            {% for config in config_list %}
                <div class="row align-items-center mb-2">
                    <div class="col-3 col-form-label-sm">
                        {{ config }}:
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="{{config}}_type" name="{{config}}_type">
                            <option selected value="range">range</option>
                            <option value="choice">choice</option>
                            <option value="fixed">fixed</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="text" class="form-control form-control-sm" id="{{config}}_value" name="{{config}}_value" placeholder="1, 2, 3">
                    </div>
                </div>
            {% endfor %}

            <!-- Objective -->
            <h6 class="fw-bold mt-3 mb-1">Objectives</h6>
            {% for objective in return_list %}
                <div class="row align-items-center mb-2">
                    <div class="col-3 col-form-label-sm">
                        {{ objective }}:
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="{{objective}}_min" name="{{objective}}_min">
                            <option selected>minimize</option>
                            <option>maximize</option>
                            <option>none</option>
                        </select>
                    </div>
                </div>
            {% endfor %}

            <h6 class="fw-bold mt-3 mb-1">Budget</h6>
            <div class="input-group mb-3">
                <label class="input-group-text" for="repeat">Max iteration </label>
                <input class="form-control" type="number" id="repeat" name="repeat" min="1" max="1000" value="25">
            </div>

            {% if not no_deck_warning%}
                <div class="input-group mb-3">
                    <button class="form-control" type="submit" name="bo">Run</button>
                </div>
            {% endif %}
        </div>
    </form>
</div>


                </div>
            </div>
        {% else %}
            <div class="col-lg-6 col-sm-12" id="placeholder-panel">
            </div>
        {% endif %}

        <div class="col-lg-6 col-sm-12" id="code-panel" style="{{ '' if pause_status else 'display: none;'}}">
            <p>
                <h5>Progress：</h5>
                {% if "prep" in line_collection.keys() %}
                    {% set stype = "prep" %}
                    <h6>Preparation：</h6>
                    {% for code in line_collection["prep"] %}
                        <pre style="margin: 0; padding: 0; line-height: 1;"><code class="python" id="{{ stype }}-{{ loop.index0 }}" >{{code}}</code></pre>
                    {% endfor %}
                {% endif %}
                {% if "script" in line_collection.keys() %}
                    {% set stype = "script" %}
                    <h6>Experiment：</h6>
                    {% for code in line_collection["script"] %}
                        <pre style="margin: 0; padding: 0; line-height: 1;"><code class="python" id="{{ stype }}-{{ loop.index0 }}" >{{code}}</code></pre>
                    {% endfor %}
                {% endif %}
                {% if "cleanup" in line_collection.keys() %}
                    {% set stype = "cleanup" %}
                    <h6>Cleanup：</h6>
                    {% for code in line_collection["cleanup"] %}
                        <pre style="margin: 0; padding: 0; line-height: 1;"><code class="python" id="{{ stype }}-{{ loop.index0 }}" >{{code}}</code></pre>
                    {% endfor %}
                {% endif %}
            </p>
        </div>
        <div class="col-lg-6 col-sm-12 logging-panel">
            <p>
                <div class="p d-flex justify-content-between align-items-center">
                    <h5>Progress：</h5>
                    <div class="d-flex gap-2 ms-auto">
                        <button id="pause-resume" class="btn btn-info text-white" data-bs-toggle="tooltip" title="Pause execution">
                            {% if pause_status %}
                                <i class="bi bi-play-circle"></i>
                            {% else %}
                                <i class="bi bi-pause-circle"></i>
                            {% endif %}
                        </button>
                        <button id="abort-current" class="btn btn-danger text-white" data-bs-toggle="tooltip" title="Stop execution after current step">
                            <i class="bi bi-stop-circle"></i>
                        </button>
                        <button id="abort-pending" class="btn btn-warning text-white" data-bs-toggle="tooltip" title="Stop execution after current iteration">
                            <i class="bi bi-hourglass-split"></i>
                        </button>
                    </div>
                </div>
                <div class="text-muted mt-2">
                    <small><strong>Note:</strong> The current step cannot be paused or stopped until it completes. </small>
                </div>

            <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
                <div id="progress-bar-inner" class="progress-bar progress-bar-striped progress-bar-animated"></div>
            </div>
            <p><h5>Log：</h5></p>
            <div id="logging-panel"></div>
        </div>

    </div>

    {# Include error modal #}
    {% include 'components/error_modal.html' %}

    <script src="{{ url_for('static', filename='js/socket_handler.js') }}"></script>
    <script>
        var rowCount = 0;
        var configColumns = [
            {% for column in config_list %}
                '{{ column }}'{{ ',' if not loop.last else '' }}
            {% endfor %}
        ];
        var configTypes = {
            {% for column, type in config_type_list.items() %}
                '{{ column }}': '{{ type }}'{{ ',' if not loop.last else '' }}
            {% endfor %}
        };

        // State management
        var originalFileData = null;
        var isModifiedFromFile = false;
        var saveTimeout = null;
        var lastSavedData = null;

        function addRow(data = null, skipSave = false) {
            rowCount++;
            var tableBody = document.getElementById("tableBody");
            var newRow = tableBody.insertRow(-1);

            // Row number cell
            var rowNumCell = newRow.insertCell(-1);
            rowNumCell.innerHTML = '<span class="badge bg-secondary">' + rowCount + '</span>';

            // Data cells
            configColumns.forEach(function(column, index) {
                var cell = newRow.insertCell(-1);
                var value = data && data[column] ? data[column] : '';
                var placeholder = configTypes[column] || 'value';
                cell.innerHTML = '<input type="text" class="form-control form-control-sm" name="' +
                    column + '[' + rowCount + ']" value="' + value + '" placeholder="' + placeholder +
                    '" oninput="onInputChange()" onchange="onInputChange()">';
            });

            // Action cell
            var actionCell = newRow.insertCell(-1);
            actionCell.innerHTML = '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)" title="Remove row">' +
                '<i class="bi bi-trash"></i></button>';

            if (!skipSave) {
                markAsModified();
                debouncedSave();
            }
        }

        function removeRow(button) {
            var row = button.closest('tr');
            row.remove();
            updateRowNumbers();
            markAsModified();
            debouncedSave();
        }

        function updateRowNumbers() {
            var tableBody = document.getElementById("tableBody");
            var rows = tableBody.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {
                var badge = rows[i].querySelector('.badge');
                if (badge) {
                    badge.textContent = i + 1;
                }
            }
        }

        function clearAllRows() {
            if (confirm('Are you sure you want to clear all rows?')) {
                var tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = '';
                rowCount = 0;
                markAsModified();
                clearSavedData();
                // Add 5 empty rows by default
                for (let i = 0; i < 5; i++) {
                    addRow(null, true);
                }
                debouncedSave();
            }
        }

        function resetToFile() {
            if (originalFileData && confirm('Reset to original file data? This will lose all manual changes.')) {
                loadDataFromSource(originalFileData, false);
                isModifiedFromFile = false;
                updateStatusIndicators();
                debouncedSave();
            }
        }

        function onInputChange() {
            markAsModified();
            debouncedSave();
        }

        function markAsModified() {
            if (originalFileData) {
                isModifiedFromFile = true;
                updateStatusIndicators();
            }
        }

        function updateStatusIndicators() {
            var modifiedStatus = document.getElementById('modifiedStatus');
            var resetBtn = document.getElementById('resetToFileBtn');

            if (isModifiedFromFile && originalFileData) {
                modifiedStatus.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
            } else {
                modifiedStatus.style.display = 'none';
                resetBtn.style.display = 'none';
            }
        }

        function showSaveStatus() {
            var saveStatus = document.getElementById('saveStatus');
            saveStatus.style.display = 'inline-block';
            setTimeout(function() {
                saveStatus.style.display = 'none';
            }, 2000);
        }

        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function() {
                saveFormData();
                showSaveStatus();
            }, 1000); // Save 1 second after user stops typing
        }

        function saveFormData() {
            var formData = getCurrentFormData();
            try {
                sessionStorage.setItem('configFormData', JSON.stringify(formData));
                sessionStorage.setItem('configModified', isModifiedFromFile.toString());
                lastSavedData = formData;
            } catch (e) {
                console.warn('Could not save form data to sessionStorage:', e);
            }
        }

        function getCurrentFormData() {
            var tableBody = document.getElementById("tableBody");
            var rows = tableBody.getElementsByTagName('tr');
            var data = [];

            for (var i = 0; i < rows.length; i++) {
                var inputs = rows[i].getElementsByTagName('input');
                var rowData = {};
                var hasData = false;

                for (var j = 0; j < inputs.length; j++) {
                    var input = inputs[j];
                    var name = input.name;
                    if (name) {
                        var columnName = name.substring(0, name.indexOf('['));
                        rowData[columnName] = input.value;
                        if (input.value.trim() !== '') {
                            hasData = true;
                        }
                    }
                }

                if (hasData) {
                    data.push(rowData);
                }
            }

            return data;
        }

        function loadSavedData() {
            try {
                var savedData = sessionStorage.getItem('configFormData');
                var savedModified = sessionStorage.getItem('configModified');

                if (savedData) {
                    var parsedData = JSON.parse(savedData);
                    isModifiedFromFile = savedModified === 'true';
                    return parsedData;
                }
            } catch (e) {
                console.warn('Could not load saved form data:', e);
            }
            return null;
        }

        function clearSavedData() {
            try {
                sessionStorage.removeItem('configFormData');
                sessionStorage.removeItem('configModified');
            } catch (e) {
                console.warn('Could not clear saved data:', e);
            }
        }

        function loadDataFromSource(data, isFromFile = false) {
            // Clear existing rows
            var tableBody = document.getElementById("tableBody");
            tableBody.innerHTML = '';
            rowCount = 0;

            // Add rows with data
            data.forEach(function(rowData) {
                addRow(rowData, true);
            });

            // Add a few empty rows for additional input
            for (let i = 0; i < 3; i++) {
                addRow(null, true);
            }

            if (isFromFile) {
                originalFileData = JSON.parse(JSON.stringify(data)); // Deep copy
                isModifiedFromFile = false;
                clearSavedData(); // Clear saved data when loading from file
            }

            updateStatusIndicators();
        }

        function loadConfigData() {
            // Check for saved form data first
            var savedData = loadSavedData();

            {% if config_preview %}
                var fileData = {{ config_preview | tojson | safe }};
                originalFileData = JSON.parse(JSON.stringify(fileData)); // Deep copy

                if (savedData && savedData.length > 0) {
                    // Load saved data if available
                    loadDataFromSource(savedData, false);
                    console.log('Loaded saved form data');
                } else {
                    // Load from file
                    loadDataFromSource(fileData, true);
                    console.log('Loaded file data');
                }
            {% else %}
                if (savedData && savedData.length > 0) {
                    // Load saved data
                    loadDataFromSource(savedData, false);
                    console.log('Loaded saved form data');
                } else {
                    // Add default empty rows
                    for (let i = 0; i < 5; i++) {
                        addRow(null, true);
                    }
                }
            {% endif %}
        }

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            saveFormData();
        });

        // Initialize table when page loads
        document.addEventListener("DOMContentLoaded", function() {
            loadConfigData();
        });
    </script>
{% endblock %}